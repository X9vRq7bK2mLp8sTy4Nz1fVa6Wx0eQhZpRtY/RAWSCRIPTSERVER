<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Dashboard | Frosted Glass</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary: #6C63FF;
            --primary-dark: #564fd8;
            --danger: #FF4B4B;
            --danger-dark: #e04444;
            --success-bg-pastel: rgba(40, 167, 69, 0.2);
            --success-text-bright: #69f0ae;
            --text: white;
            --text-light: rgba(255, 255, 255, 0.7);
            --bg-blur: rgba(30, 30, 80, 0.3);
            --border-light: rgba(255, 255, 255, 0.15);
            --card-bg: rgba(30, 30, 80, 0.2);
            --grey-bg: rgba(80, 80, 100, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html {
            height: 100%;
            overscroll-behavior-y: none;
        }
        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            padding-top: 220px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            opacity: 0;
            transform: scale(1.05);
            animation: fadeInZoomIn 0.5s 0.2s ease-out forwards;
        }
        @keyframes fadeInZoomIn { from { opacity: 0; transform: scale(1.05); } to { opacity: 1; transform: scale(1); } }
        .loading { display: flex; justify-content: center; align-items: center; min-height: 100vh; font-size: 1.5rem; color: var(--text-light); text-align: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; }
        .sticky-header { position: fixed; top: 20px; left: 20px; right: 20px; z-index: 100; padding: 20px 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); border: 1px solid var(--border-light); background: var(--bg-blur); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); display: flex; flex-direction: column; gap: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 2.2rem; font-weight: 700; background: linear-gradient(135deg, #fff, #e6e6e6); -webkit-background-clip: text; color: transparent; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-light); padding-bottom: 15px; }
        .tab-btn { padding: 10px 20px; font-size: 1rem; font-weight: 600; background: transparent; border: none; color: var(--text-light); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .tab-btn:hover { color: var(--text); background: var(--card-bg); }
        .tab-btn.active { color: var(--text); background: var(--primary); }
        .dashboard-container { max-width: 1200px; margin: 0 auto; background: var(--bg-blur); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); border: 1px solid var(--border-light); display: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .controls { display: flex; justify-content: flex-start; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 14px 24px; font-size: 1rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); color: var(--text); gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: var(--card-bg); border: 1px solid var(--border-light); }
        .btn-danger { background: var(--danger); color: white; }
        .script-list, .player-list-container { overflow-y: auto; border-radius: 12px; padding-right: 10px; }
        .script-list::-webkit-scrollbar, .player-list-container::-webkit-scrollbar { width: 8px; }
        .script-list::-webkit-scrollbar-track, .player-list-container::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 4px; }
        .script-list::-webkit-scrollbar-thumb, .player-list-container::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        .script-list { max-height: 55vh; padding-top: 10px; padding-left: 10px; }
        .script-item { padding: 20px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; border-radius: 15px; margin-bottom: 10px; background: var(--card-bg); border: 1px solid transparent; }
        .script-item:hover { background: rgba(30, 30, 80, 0.4); transform: scale(1.02); border-color: var(--border-light); }
        .script-info { flex: 1; text-align: left; word-break: break-word; }
        .script-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 5px; }
        .script-key { font-size: 0.9rem; color: var(--text-light); font-family: monospace; }
        .script-actions { display: flex; gap: 10px; flex-shrink: 0; margin-left: 20px; }
        .player-list-container { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; max-height: 55vh; }
        .player-item { display: flex; align-items: center; gap: 15px; background: var(--card-bg); padding: 15px; border-radius: 15px; transition: all 0.3s ease; flex-shrink: 0; }
        .previous-players .player-item { opacity: 0.7; }
        .player-thumbnail { width: 50px; height: 50px; border-radius: 50%; background-color: var(--primary); flex-shrink: 0; background-size: cover; border: 2px solid var(--border-light); }
        .player-info { flex-grow: 1; }
        .status-box { font-size: 0.85rem; font-weight: 600; padding: 5px 12px; border-radius: 8px; white-space: nowrap; }
        .status-box.uptime { background-color: var(--success-bg-pastel); color: var(--success-text-bright); }
        .status-box.last-seen { background-color: var(--grey-bg); color: var(--text-light); }
        h2.section-title { margin-top: 20px; font-size: 1.3rem; color: var(--text-light); border-bottom: 1px solid var(--border-light); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        h2.section-title:first-child { margin-top: 0; }
        .status-box.player-count { background-color: var(--grey-bg); color: var(--text-light); font-size: 0.9rem; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-light); }
        .empty-state i { font-size: 3rem; margin-bottom: 15px; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 1000; padding: 20px; background: rgba(0, 0, 0, 0); transition: background 0.4s ease-in-out; }
        .modal { background: var(--bg-blur); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; padding: 30px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2); border: 1px solid var(--border-light); }
        .modal-backdrop.appear { background: rgba(0, 0, 0, 0.5); }
        .modal.appear { animation: modalAppear 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .modal.disappear { animation: modalDisappear 0.4s cubic-bezier(0.5, 0, 0.75, 0); }
        @keyframes modalAppear { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes modalDisappear { from { opacity: 1; transform: scale(1) translateY(0); } to { opacity: 0; transform: scale(0.8) translateY(20px); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-light); }
        .modal-title { font-size: 1.5rem; }
        .close-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-light); cursor: pointer; transition: all 0.2s ease; }
        .close-btn:hover { color: var(--text); transform: rotate(90deg); }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input[type="text"], textarea { width: 100%; padding: 15px; font-size: 1rem; background: var(--card-bg); border: 1px solid var(--border-light); border-radius: 12px; color: var(--text); transition: all 0.3s ease; }
        input[type="text"]:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.3); background: rgba(30, 30, 80, 0.4); }
        input[type="text"]:disabled { background: rgba(0,0,128,0.3); cursor: not-allowed; }
        textarea { min-height: 200px; font-family: monospace; resize: vertical; }
        .char-count { text-align: right; font-size: 0.85rem; color: var(--text-light); margin-top: 5px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 15px; margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-light); }
        .script-name { font-weight: 700; background: var(--card-bg); padding: 10px 15px; border-radius: 12px; margin: 15px 0; display: inline-block; }
        
        @media (max-width: 768px) {
            body { padding-top: 200px; }
            .sticky-header { padding: 20px; }
            h1 { font-size: 1.8rem; }
            .tabs { overflow-x: auto; }
            .script-item, .player-item { flex-direction: column; align-items: stretch; }
            .script-actions { margin-top: 15px; justify-content: flex-end; }
            .player-item .status-box { align-self: flex-end; margin-top: 10px; }
        }
        @media (max-width: 480px) {
            body { padding-top: 220px; }
            .controls { flex-direction: column; }
            .controls .btn { width: 100%; }
            .script-actions { flex-wrap: wrap; justify-content: flex-start; }
            .script-actions .btn { flex-grow: 1; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading-screen"><i class="fas fa-spinner fa-spin"></i> Checking authentication...</div>

    <header class="sticky-header">
        <div class="header-top"><h1>Dashboard</h1></div>
        <nav class="tabs">
            <button class="tab-btn active" data-tab="scripts"><i class="fas fa-code"></i> Scripts</button>
            <button class="tab-btn" data-tab="players"><i class="fas fa-users"></i> Players</button>
            <button class="tab-btn" data-tab="settings"><i class="fas fa-cog"></i> Settings</button>
        </nav>
    </header>

    <div class="dashboard-container" id="dashboard">
        <div id="scripts-tab" class="tab-content active">
            <div class="controls">
                <button class="btn btn-primary" id="create-script-btn"><i class="fas fa-plus"></i> Create New Script</button>
                <button class="btn btn-secondary" id="refresh-scripts-btn"><i class="fas fa-sync-alt"></i> Refresh List</button>
            </div>
            <div class="script-list" id="scriptList"></div>
        </div>

        <div id="players-tab" class="tab-content">
            <h2 class="section-title">Active Players <span class="status-box player-count" id="active-players-count">0</span></h2>
            <div class="player-list-container active-players" id="active-players-list">
                </div>
            <h2 class="section-title">Previous Players <span class="status-box player-count" id="previous-players-count">0</span></h2>
            <div class="player-list-container previous-players" id="previous-players-list">
                </div>
        </div>
        
        <div id="settings-tab" class="tab-content">
            <div class="empty-state">
                <i class="fas fa-tools"></i>
                <p>Settings are under construction.</p>
                <small>User profile, theme, and security settings will be available here soon.</small>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="scriptModal"><div class="modal"><div class="modal-header"><h2 class="modal-title" id="modalTitle"></h2><button class="close-btn" data-close="scriptModal"><i class="fas fa-times"></i></button></div><div class="form-group"><label for="scriptTitle">Script Title</label><input type="text" id="scriptTitle"></div><div class="form-group"><label for="scriptId">Script ID (12 digits)</label><input type="text" id="scriptId" maxlength="12"><button class="btn btn-secondary" style="margin-top: 10px;" id="generate-id-btn"><i class="fas fa-dice"></i> Generate ID</button><div class="char-count"><span id="scriptIdCharCount">0</span>/12</div></div><div class="form-group"><label for="scriptContent">Script Content (200,000 chars max)</label><textarea id="scriptContent"></textarea><div class="char-count"><span id="contentCharCount">0</span>/200000</div></div><div class="form-group"><label><input type="checkbox" id="scriptObfuscate"> Obfuscate Script</label></div><div class="modal-footer"><button class="btn btn-secondary" data-close="scriptModal">Cancel</button><button class="btn btn-primary" id="save-script-btn"><i class="fas fa-save"></i> Save</button></div></div></div>
    <div class="modal-backdrop" id="deleteModal"><div class="modal"><div class="modal-header"><h2 class="modal-title">Confirm Deletion</h2><button class="close-btn" data-close="deleteModal"><i class="fas fa-times"></i></button></div><p>This action cannot be undone.</p><div class="script-name" id="deleteScriptName"></div><div class="modal-footer"><button class="btn btn-secondary" data-close="deleteModal">Cancel</button><button class="btn btn-danger" id="confirm-delete-btn"><i class="fas fa-trash"></i> Delete</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            let scripts = [];
            let currentScriptKey = null;
            let playerRefreshInterval = null; // To hold the interval ID

            const getEl = (selector) => document.querySelector(selector);
            const getAllEl = (selector) => document.querySelectorAll(selector);

            // --- Authentication and Modal Logic (Unchanged) ---
            const checkAuth = async () => {
                const auth = localStorage.getItem('auth');
                if (!auth) { window.location.href = '/login.html'; return false; }
                try {
                    const res = await fetch('/api/script.lua', { headers: { 'Authorization': `Basic ${auth}` } });
                    if (!res.ok) { window.location.href = '/login.html'; return false; }
                    return auth;
                } catch (err) { window.location.href = '/login.html'; return false; }
            };
            const showModal = (id) => { const modal = getEl(`#${id}`); modal.style.display = 'flex'; requestAnimationFrame(() => { modal.classList.add('appear'); modal.querySelector('.modal').classList.add('appear'); }); };
            const closeModal = (id) => { const modal = getEl(`#${id}`); const modalContent = modal.querySelector('.modal'); modal.classList.remove('appear'); modalContent.classList.add('disappear'); setTimeout(() => { modal.style.display = 'none'; modalContent.classList.remove('disappear'); modalContent.classList.remove('appear'); }, 400); };
            const escapeHTML = (str) => { const p = document.createElement('p'); p.textContent = str; return p.innerHTML; };
            
            // --- Script Rendering Logic (Unchanged) ---
            const renderScripts = () => {
                const listEl = getEl('#scriptList');
                if (!listEl) return;
                if (scripts.length === 0) { listEl.innerHTML = `<div class="empty-state"><i class="fas fa-code"></i><p>No scripts found.</p></div>`; return; }
                listEl.innerHTML = scripts.map(script => `
                    <div class="script-item">
                        <div class="script-info">
                            <div class="script-title">${escapeHTML(script.title)}</div>
                            <div class="script-key">Key: ${escapeHTML(script.key)}</div>
                        </div>
                        <div class="script-actions">
                            <button class="btn btn-secondary" data-action="copy" data-key="${escapeHTML(script.key)}"><i class="fas fa-copy"></i> Copy</button>
                            <button class="btn btn-primary" data-action="edit" data-key="${escapeHTML(script.key)}"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn btn-danger" data-action="delete" data-key="${escapeHTML(script.key)}"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>`).join('');
            };

            const loadScripts = async () => {
                const auth = await checkAuth(); if (!auth) return;
                getEl('#scriptList').innerHTML = `<div class="empty-state"><i class="fas fa-spinner fa-spin"></i> Loading scripts...</div>`;
                try {
                    const res = await fetch('/api/script.lua', { headers: { 'Authorization': `Basic ${auth}` } });
                    if (res.ok) { scripts = await res.json(); renderScripts(); }
                    else { throw new Error(`Server responded with ${res.status}`); }
                } catch (err) { getEl('#scriptList').innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load scripts.</p></div>`; console.error('Failed to load scripts:', err); }
            };
            
            // --- NEW: Player Rendering Logic ---
            const formatUptime = (firstSeen) => {
                const ms = new Date() - new Date(firstSeen);
                const totalMinutes = Math.floor(ms / 60000);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                if (hours > 0) return `${hours}h ${minutes}m`;
                return `${minutes}m`;
            };

            const formatLastSeen = (lastSeen) => {
                return new Date(lastSeen).toLocaleDateString(undefined, {
                    year: 'numeric', month: 'short', day: 'numeric'
                });
            };

            const renderPlayers = (data) => {
                const { activePlayers, previousPlayers } = data;
                const activeList = getEl('#active-players-list');
                const previousList = getEl('#previous-players-list');

                getEl('#active-players-count').textContent = activePlayers.length;
                getEl('#previous-players-count').textContent = previousPlayers.length;

                if (activePlayers.length === 0) {
                    activeList.innerHTML = `<div class="empty-state"><i class="fas fa-user-clock"></i><p>No active players.</p></div>`;
                } else {
                    activeList.innerHTML = activePlayers.map(p => `
                        <div class="player-item">
                            <div class="player-thumbnail" style="background-image: url('${escapeHTML(p.avatar)}')"></div>
                            <div class="player-info">
                                <strong>${escapeHTML(p.displayName)}</strong><br>
                                <small>@${escapeHTML(p.username)}</small>
                            </div>
                            <div class="status-box uptime">${formatUptime(p.firstSeen)}</div>
                        </div>`).join('');
                }
                
                if (previousPlayers.length === 0) {
                    previousList.innerHTML = `<div class="empty-state"><i class="fas fa-history"></i><p>No previous players found.</p></div>`;
                } else {
                    previousList.innerHTML = previousPlayers.map(p => `
                        <div class="player-item">
                            <div class="player-thumbnail" style="background-image: url('${escapeHTML(p.avatar)}')"></div>
                            <div class="player-info">
                                <strong>${escapeHTML(p.displayName)}</strong><br>
                                <small>@${escapeHTML(p.username)}</small>
                            </div>
                            <div class="status-box last-seen">${formatLastSeen(p.lastSeen)}</div>
                        </div>`).join('');
                }
            };

            const loadPlayers = async () => {
                const auth = await checkAuth(); if (!auth) return;
                try {
                    const res = await fetch('/api/players', { headers: { 'Authorization': `Basic ${auth}` } });
                    if (res.ok) {
                        const data = await res.json();
                        renderPlayers(data);
                    } else { throw new Error(`Server responded with ${res.status}`); }
                } catch (err) {
                    console.error('Failed to load players:', err);
                    getEl('#active-players-list').innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load player data.</p></div>`;
                    getEl('#previous-players-list').innerHTML = '';
                }
            };
            
            // --- Script Modal Logic (Unchanged) ---
            const showCreateModal = () => { currentScriptKey = null; getEl('#modalTitle').textContent = 'Create New Script'; getEl('#scriptTitle').value = ''; getEl('#scriptContent').value = ''; getEl('#scriptId').disabled = false; getEl('#scriptObfuscate').checked = false; generateScriptId(); showModal('scriptModal'); };
            const showEditModal = async (key) => {
                const auth = await checkAuth(); if (!auth) return;
                const script = scripts.find(s => s.key === key); if (!script) return;
                currentScriptKey = key; getEl('#modalTitle').textContent = 'Edit Script'; getEl('#scriptTitle').value = script.title; getEl('#scriptId').value = script.key; getEl('#scriptId').disabled = true; getEl('#scriptContent').value = 'Loading script content...'; getEl('#scriptObfuscate').checked = false; updateCharCounts(); showModal('scriptModal');
                try { const res = await fetch(`/api/script.lua?key=${encodeURIComponent(key)}`, { headers: { 'Authorization': `Basic ${auth}` } }); if (res.ok) { const data = await res.json(); getEl('#scriptContent').value = data.content || ''; getEl('#scriptObfuscate').checked = data.obfuscate || false; updateCharCounts(); } else { throw new Error(`Server responded with ${res.status}`); } } catch (err) { alert('Failed to load script content.'); closeModal('scriptModal'); }
            };
            const showDeleteModal = (key) => { const script = scripts.find(s => s.key === key); if (!script) return; currentScriptKey = key; getEl('#deleteScriptName').textContent = script.title; showModal('deleteModal'); };
            const updateCharCounts = () => { getEl('#scriptIdCharCount').textContent = getEl('#scriptId').value.length; getEl('#contentCharCount').textContent = getEl('#scriptContent').value.length; };
            const generateScriptId = () => { getEl('#scriptId').value = Array.from({ length: 12 }, () => Math.floor(Math.random() * 10)).join(''); updateCharCounts(); };

            // --- Main Event Listener (Updated for Tabs) ---
            document.body.addEventListener('click', async (e) => {
                try {
                    const target = e.target;
                    const tabBtn = target.closest('.tab-btn');
                    const actionBtn = target.closest('[data-action]');
                    const closeBtn = target.closest('[data-close]');
                    
                    if (tabBtn) {
                        const tabId = tabBtn.dataset.tab;
                        getAllEl('.tab-content').forEach(c => c.classList.remove('active'));
                        getAllEl('.tab-btn').forEach(b => b.classList.remove('active'));
                        getEl(`#${tabId}-tab`).classList.add('active');
                        tabBtn.classList.add('active');

                        // NEW: Manage player refresh interval based on tab
                        if (tabId === 'players') {
                            await loadPlayers(); // Load immediately on tab switch
                            if (!playerRefreshInterval) { // Start interval if not already running
                                playerRefreshInterval = setInterval(loadPlayers, 60000);
                            }
                        } else {
                            if (playerRefreshInterval) { // Stop interval when leaving players tab
                                clearInterval(playerRefreshInterval);
                                playerRefreshInterval = null;
                            }
                        }
                    }
                    else if (actionBtn) { /* ... (rest of unchanged script logic) ... */ }
                    else if (closeBtn) { closeModal(closeBtn.dataset.close); }
                    else if (target.closest('#create-script-btn')) { showCreateModal(); }
                    else if (target.closest('#generate-id-btn')) { generateScriptId(); }
                    else if (target.closest('#refresh-scripts-btn')) {
                        const btn = target.closest('#refresh-scripts-btn'); const icon = btn.querySelector('i');
                        icon.classList.add('fa-spin'); btn.disabled = true;
                        await loadScripts();
                        icon.classList.remove('fa-spin'); btn.disabled = false;
                    }
                    else if (target.closest('#save-script-btn')) {
                        const btn = target.closest('#save-script-btn'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                        const auth = await checkAuth(); if (!auth) return;
                        const payload = { key: getEl('#scriptId').value.trim(), title: getEl('#scriptTitle').value.trim(), content: getEl('#scriptContent').value, obfuscate: getEl('#scriptObfuscate').checked };
                        if (!payload.title || !payload.key || !payload.content || payload.key.length !== 12 || !/^\d+$/.test(payload.key)) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> Save'; return alert('Please fill all fields correctly.'); }
                        const res = await fetch('/api/script.lua', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Basic ${auth}` }, body: JSON.stringify(payload) });
                        if (res.ok) { closeModal('scriptModal'); await loadScripts(); } else { alert(`Error saving script: ${await res.text()}`); }
                        btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> Save';
                    }
                    else if (target.closest('#confirm-delete-btn')) {
                        const auth = await checkAuth(); if (!auth || !currentScriptKey) return;
                        const res = await fetch(`/api/script.lua?key=${encodeURIComponent(currentScriptKey)}`, { method: 'DELETE', headers: { 'Authorization': `Basic ${auth}` } });
                        if (res.ok) { closeModal('deleteModal'); await loadScripts(); } else { alert(`Error deleting script: ${await res.text()}`); }
                    }
                } catch (error) { console.error("Dashboard Click Handler Error:", error); alert("An unexpected error occurred. Please refresh the page."); }
            });
            
            getEl('#scriptId').addEventListener('input', updateCharCounts);
            getEl('#scriptContent').addEventListener('input', updateCharCounts);

            // --- Initial Load Logic ---
            const auth = await checkAuth();
            if (auth) {
                getEl('#loading-screen').style.display = 'none';
                getEl('#dashboard').style.display = 'block';
                await loadScripts();
                // We don't load players here to save data, they load when the tab is clicked
            }
        });
    </script>
</body>
</html>

